# Update fee and dust handling for zero fee channels

## Runthrough 1

Goals:
- Self review of code
- Check where we'll change things for `TxBuilder` rebase
- Note places where tests can be added

Items with [ ] need to be addressed on next pass / rebase. If they have
and [x] then they've been resolved.

### ln/refactor: add utility to get commitment feerate by channel type

- Moves all commitment feerate calculations into one place
- No logical changes

`TxBuilder`?
- After the first PR, we still have some inline checks to get the
  feerate based on the channel type
- We also have a `get_commitment_feerate` function which checks for
  any pending fee updates

[ ] Q: Could this refactor be combined with `get_commitment_feerate`?
- These seem to have slightly different uses, one is for

`Tests`?
- We'd just need to mock out the fee estimator for a pretty trivial
  test, so okay without explicit coverage

### ln: return Option for dust_exposure_limiting_feerate

- `get_dust_exposure_limiting_feerate` doesn't really make sense for
  zero fee commitments - dust doesn't contribute to fees
- `get_max_dust_htlc_exposure_msat` defaults to 1sat/vbyte if `None`
  is provided

Q: What defenses do we have against `get_max_dust_htlc_exposure_msat`
  accidentally being called with `None` for a channel that actually
  has fee-dependent dust?
- We've got a check that if we're zero fee then we're none, but not
  the reverse (if we're none, we must be zero fee)

[x] Update assert to match in both directions (this should actually
    happen in the next commit), moved the assert to next one.

`TxBuilder`?
- No conflicts (with current version)

`Tests`?
- Should be unchanged, so whatever coverage we already have should
  be sufficient

### ln: add channel type awareness to get_dust_exposure_limiting_feerate

- Pass channel type into dust exposure so that zero fee commitments
  can return a `None` value
- `excess_feerate_opt` should always be `Some(0)` for zero fee comms

[ ] Q: do we want to implicitly go through all this logic assuming
    that we'll pop out with a zero value for zero fee commitments or
    do we just want to return early?

`TxBuilder`:
- No conflicts (with current version)

`Tests`?
[ ] Need some coverage that'll check that we don't get an excess feerate
   on zero fee commitments (it doesn't make sense)

### ln: remove unnecessary nonzero anchor channel check in build_htlc_output

- Removes an unnecessary check from `build_htlc_output`, we check that
  a channel isn't _both_ nonzero anchors and zero anchors; but we never
  define any channel types that are both of these so they're redundant.

`TxBuilder`?
- No conflicts (with current version)

`Tests`?
- Existing coverage should be sufficient.

### ln/refactor: move success/timeout dust limits into helper

- Pulls dust calculations out into their own function
[x] Need to move function into `chan_utils.rs`
[ ] Check fixup commit is okay?

[ ] Pre-existing `next_local_commit_tx_fee_msat` should use counterparty
    for remote offered? 4982 
    ? Likewise for 5091 in `next_remote_commit_tx_fee_msat`?

`TxBuilder`?
- This will conflict because the existing PR has already changed
  `commit_and_htlc_tx_fees_sat` to just be `htlc_fees`
- Likely to have other conflicts with dust checks!

`Tests`?
- No new functionality to test, existing coverage should be sufficient.

### ln: set zero second stage fees for zero fee commitments

`TxBuilder`?
- No conflicts (with current version).

`Tests`?
[ ] Should have a test that checks second stage htlcs on zero fee
    commitments will be zero fee? If we're even able to make these
    commitmements yet?

### ln: return early and assert in fee calculation and checks

- Adds zero returns for next commitment feerate and stale fee checks

`TxBuilder`?
- No conflicts (with current version)

`Tests`?
[ ] We have zero fee commitments for these channels
[ ] We don't close them due to stale feerates

### ln: do not send and reject receive of update_fee for zero fee commits

- Never return true for fee updates for zero fee commitment channels

`TxBuilder`?
- No conflicts

`Tests`?
- Already covered

### ln: do not maintain fee spike buffer for zero fee commitment channels

`TxBuilder`?
- Will conflict with some existing dust / fee spike checks

`Tests`?
[ ] Need a test that checks that we don't reserve fee spike space 
    for a zero fee channel.

