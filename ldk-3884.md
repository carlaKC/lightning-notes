# Update fee and dust handling for zero fee channels

## Runthrough 1

Goals:
- Self review of code
- Check where we'll change things for `TxBuilder` rebase
- Note places where tests can be added

Items with [ ] need to be addressed on next pass / rebase. If they have
and [x] then they've been resolved.

### ln/refactor: add utility to get commitment feerate by channel type

- Moves all commitment feerate calculations into one place
- No logical changes

`TxBuilder`?
- After the first PR, we still have some inline checks to get the
  feerate based on the channel type
- We also have a `get_commitment_feerate` function which checks for
  any pending fee updates

[ ] Q: Could this refactor be combined with `get_commitment_feerate`?
- These seem to have slightly different uses, one is for

### ln: return Option for dust_exposure_limiting_feerate

- `get_dust_exposure_limiting_feerate` doesn't really make sense for
  zero fee commitments - dust doesn't contribute to fees
- `get_max_dust_htlc_exposure_msat` defaults to 1sat/vbyte if `None`
  is provided

Q: What defenses do we have against `get_max_dust_htlc_exposure_msat`
  accidentally being called with `None` for a channel that actually
  has fee-dependent dust?
- We've got a check that if we're zero fee then we're none, but not
  the reverse (if we're none, we must be zero fee)

[x] Update assert to match in both directions (this should actually
    happen in the next commit), moved the assert to next one.

### ln: add channel type awareness to get_dust_exposure_limiting_feerate

- Pass channel type into dust exposure so that zero fee commitments
  can return a `None` value
- `excess_feerate_opt` should always be `Some(0)` for zero fee comms

[ ] Q: do we want to implicitly go through all this logic assuming
    that we'll pop out with a zero value for zero fee commitments or
    do we just want to return early?

### ln: remove unnecessary nonzero anchor channel check in build_htlc_output

- Removes an unnecessary check from `build_htlc_output`, we check that
  a channel isn't _both_ nonzero anchors and zero anchors; but we never
  define any channel types that are both of these so they're redundant.

### ln/refactor: move success/timeout dust limits into helper

- Pulls dust calculations out into their own function
[x] Need to move function into `chan_utils.rs`

### ln: set zero second stage fees for zero fee commitments

### ln: return early and assert in fee calculation and checks

- Adds zero returns for next commitment feerate and stale fee checks

### ln: do not send and reject receive of update_fee for zero fee commits

- Never return true for fee updates for zero fee commitment channels

### ln: do not maintain fee spike buffer for zero fee commitment channels

- Question about whether to assert - Matt thinks its fine

## Summary:

`TxBuilder`:
- Nothing really needs to fundamentally change.
- Most of the refactors are complimentary, perhaps just fewer LOC.

`Tests`:
- [ ] Don't reserve a fee spike buffer for a zero fee channel 
- [ ] Commitment fees are actually chosen to be zero
- [ ] We don't close them due to stale feerates
- [ ] A test that covers zero fee second stage commitments not impacting
      dust/commit affordablility (piggybacked on anchor channels if
      possible).
- [ ] Coverage that we don't actually set any excess feerate on a zero
      feerate commitment (?)

Check:
- [x] Look at the rename fixup commit I did and squash it
- [x] Pre-existing check that `next_local_commit_tx_fee_msat` and
      `next_remote_commit_tx_fee_msat` are using the correct dust
      limits - they're using either holder or counterparty for both
      success and timeout (channel / 4982 + 5091)
      -> Yes, these are only for the counterparty/local so it makes
         sense to only use one person's dust limit
