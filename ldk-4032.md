# Follow Ups from 3921

## Review Round 1

Matt has already taken a look, so only on the lookout for glaring
issues.

### Make `TxBuilder::get_next_commitment_stats` fallible

- Rather than having options and asserts, we just return an error if
  one of the balances that we expect to be sufficient isn't

Q: How do we know balance after HTLCs and anchors exhaused?
   Aren't there other errors? Eg in the update add context it's about
   the proposed htlc.
  -> These are the only error cases we currently define, perhaps if
     this is a public API we'll want to handle errors more carefully,
     but seems fine for now?
[ ] Also perhaps a rust errors thing that I need to get used to, is it
    regular to return `()` errors and just have the impl responsible
    for logging its own error string?

### Include HTLCs unknown by remote in `can_accept_incoming_htlc` stats

- Previously, we'd not include the htlcs that we haven't told our
  counterparty about yet to see whether we can accomodate a new htlc.
  But, they're imminently going to be on the commitment so we choose
  to prioritize them over this newly proposed htlc.
  -> Seems reasonable, just a matter of preference here.

### Include any pending fee updates in `can_accept_incoming_htlc`

- Similar to above, we choose to use our pending feerate which we'll
  soon be using to decide whether we can accept this htlc. It's already
  queued and if we add this htlc it's possible we won't be able to
  afford it?

Q: where is this pending?
- For example:
  - Our feerate in 10 sat/vbyte
  - Pretend htlcs are 10 vbytes for easy math, and that we currently
    have a local balance of 140
  - We send them an update fee to set to 15 sat/vbyte
  - We've just locked in the htlc (and are calling `can_accept_incoming_htlc`
    - At the old feerate, we can afford it at 100 sat
    - At the new feerate, we can't affort it at 150 sat 
  - They haven't sent us a commitment with this feerate locked in yet

### Relax feerate requirements in `TxBuilder::get_next_commitment_stats`

- Sometimes we're not worried about calculating our dust exposure, so
  we don't always need to provide the exposing feerate.

### Cleanup dust exposure due to excess fees in `get_next_commitment_stats`

Previously:
- `on_counterparty_tx_accepted_nondust_htlcs`:
  - set local = false
  - only for outbound htlcs
  -> This would give us all the non dust htlcs on the remote party's
     commitment that we offered to them
- `on_counterparty_tx_offered_nondust_htlcs`:
  - set local = false
  - only for inbound htlcs
  -> This would give us all the non dust htlcs on the remote party's
     commitment that we received from them

Now:
- We're making a more general function, that aims to provide (?)
- If looking at remote commitment:
  - `accepted_nondust_htlcs`: htlcs that the peer received from us
  - `offered_nondust_htlcs`: htlcs that the peer offered to us
    (that are not dust according to the remote peer's dust limit)
- If looking at our commitment:
  - `accepted_nondust_htlcs`: htlcs that we received from the peer
  - `offered_nondust_htlcs`: htlcs that we offered the peer
    (that are not dust according to our dust limit)
- `commit_tx_fee_msat`: gives our fee based on the number of htlcs that
   will be on our commitment
- We also calcualte fees for "one more" htlc on our commitment.

Difference:
- Previously we used an `excess_feerate`
- Now we just use our feerate everywhere

To calculate our dust exposure:
- `dust_exposure_msat`: We add up all the dust htlcs that we have on 
  the commitment.
- If we're on the local commitment:
  - Previously: `dust_exposure_msat`, `None`
  - Now: `dust_exposure_msat`, `dust_exposure_msat`
- If we're on the remote commitment:
  - Previously: `dust_exposure_msat`, exposure of an extra htlc
  - Now: 
    `dust_exposure_msat` + `excess_fees_msat`
    `dust_exposure_msat` + `extra_accepted_htlc_excess_fees_msat`

Q: Previously did the `extra_nondust_htlc_on_counterparty_dust_exposure_msat`
   include our `dust_exposure_msat`?
  Yes!

### Note that we may want to apply HTLC deletes to the upcoming set of HTLCs

- When we get our HTLCs on the next commitment, we're currently
  including htlcs that are awaiting an ack (ie, will graduate from
  the holding cell to the commitment)
- By that logic, we can also include `FailHTLC` and `FailMalformedHTLC`
  because they'll be removed in the same commitment.

Q: Why is this currently ok?
- It's just making us slightly more conservative (we think we have more
  htlcs than we actually will) in our checks. None of this is used to
  actually build the commitment's htlcs.

### Check dust exposure on receiving commitment_signed, not update_fee

- Allow peers to send an `update_fee` that would push us over our dust
  exposure, provided that they'll send some htlcs that bring us back
  down.
- `validate_update_fee` now checks that we can afford the reserve
  (but does not check we can afford the fee)
- `validate_commitment_signed`: calls `validate_update_fee` which has
  the reserve check in it (previously did it directly)

# Come Back to!
Q: How can we have sent a update_fee that won't work for a currently
   committed htlc on a channel?
  -> Not worth holding up the review for this, but should dig into for
     my own understanding
  -> I think this is because this is just for dust exposure and it's
    not actually a stone cold balance check? Need to go back to the
    original context to check.
