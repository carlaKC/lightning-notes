# Resource Manager Impl

## Review Round 1

### Add DecayingAverage to resource manager

- Test coverage is good, all green on codecov.
- [ ] We should perhaps provide a few more "less obvious" hardcoded
  values to test decying averages (and provide them in the spec?).

### Add RevenueAverage to resource manager

- Naming is very application specific
- Needs some docs

### Add GeneralBucket to resource manager

- Why would we ever have none salt/
- Single source of truth for htlcs: saves us double-writing, downside
  is that we have to access at indices (which is yuk outtabounds yuk)
  - Do this in a defensive way then it's fine.
- [ ] Haven't reviewed tests in this commit because I think impl might
  change a little

### Add BucketResources to resource manager

- Straightforward impl
- Coverage? gg

### Add Channel to resource manager

- Do we need to have the incoming_channel on pending htlc
- [ ] `sufficient_reputation` seems like a slightly odd abstraction?
- [ ] There are a few coverage gaps that could be filled

### Add ResourceManager trait

- [x] Check mutex type in later commits
- Do we only remove a htlc if we were told to forward it? Yes.
  -> Make the doc here a little clearer.

### ResourceManager trait impl

- [ ] I have some general feeling that we should be handling different
  "levels" of errors differently. Like we removed a channel that's not
  there.

### Impl write and read for resource_manager

- Don't always need read args
- Why can we just write the unlocked hashmap but the read needs
  other actions

## Review Round 2

### Add General Bucket to resource manager (+ fixups) 

Representation of slots:
- Track per-channel vs track single source of information
- What does single source impl look like?
  - `slots_for_amount`: we need to assert that all of our indexes
    fit into the `slots_occupied` vector, I think that's fine.
    It's a really bad/unexpected bug if they don't.
  - `add_htlc`: assert that they're not already occupied, and set to
    the outgoing scid.
  - `remove_htlc`: filter our channel's slots by the ones already being
    used, and then assert that what we're clearing is already occupied.
  - `remove_channel_slots`: we need to clear each of the slots that
    our channel is using, rather than just deleting its assignments.
