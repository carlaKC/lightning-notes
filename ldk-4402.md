# Use HTLC CLTV instead of onion CLTV values for payment claim timer

Some of the CLTV stuff that I've already got in trampoline PR, pulled
up into its own PR.

## Review Round 1

### Use HTLC CLTV instead of onion CLTV values for payment claim timer

Setting the CLTV value for HTLCs that we've _received_, which is needed
to watch + timeout htlcs on chain.

Previously:
- We would use `onion_cltv_expiry`, which is obtained from the onion
  payload.
  - `Receive`: listed inside of the onion
  - `BlindedReceive`: listed in the final recipient data
  - `TrampolineReceive`: listed in the inner trampoline packet
  - `TrampolineBlindedReceive`: listed in the final recipient data

Trampoline check:
- The outer onion's cltv must be >= the inner onion's cltv.

Regular check:
- The outer onion's cltv must be > `ctlv_expiry` in `update_add_htlc`

So, in all:
- Outer onion >= inner onion
- Outer onion > update_add_htlc

This change:
- We now set the incoming cltv expiry height to be the height that we
  got in the `update_add_htlc`.

In my trampoline PR:
- I leave the value of `incoming_cltv_expiry` the same
- Instead I set the `onion_cltv_expiry` to equal the outer onion hop's
  cltv

Matt's PR:
- Now sets the `incoming_cltv_expiry` to equal the `update_add` expiry
- Use of `onion_cltv_expiry` otherwise unchanged

My PR:
- Now sets the `incoming_cltv_expiry` to equal the outer onion's expiry
- Changes `onion_cltv_expiry` to equal the onion value (which changes
  what we're validating for `final_incorrect_cltv_expiry` 

Tested against trampoline PR: works! Saves me a change!

### Fix trampoline onion encoding to match doc-declared cltv rules

In our documentation, we state that the final route hop (which is
duplicated in our trampoline hops)'s CLTV delta should include
trampoline hops cltv delta, but we did not implement it like this.

Previously:
- We'd need to add on the cltv expiry for any trampoline hops

Now:
- The CLTV for trampoline hops is included in the final route hop's
  CLTV

Changes:
- When we `create_blinded_tail`, we'll pas in an `excess_final_cltv_delta`
  that we set on our blinded route.
- When we replace our onion, we'll set the expiry to the trampoline cltv
  plus our starting offset *and* excess.


### Clarify CLTV value selection in first blinded hop marginally

`build_trampoline_onion_paylaods`
- no longer need the cltv value we're returning
- Q: how are we setting offset in caller?
  - `create_payment_onion_internal`
    - We don't need to track our outer offset from the onion packet
    - When we have `build_onion_payloads`, we can just pass in the
      current height (because the last route hop has the right value
      now; previously it didn't include trampoline!)

`build_onion_payloads_callback`:
- Get rid of the `starting_htlc_offset` issue that I had with building
  trampoline, instead just always sets the cltv to expiry of the current
  hop plus the current cltv value. For the first hop, that would be
  added to the starting offset
-> For trampolines, we just set this to the current height
-> For regular, we can _also_ just set this to the current height,
   because we set the proper delta on our trampoline hop!

`TrampolineEntry`:
- We create a trampoline entry which has cltv = offset plus the delta
  on that hop.

`DirectEntry`:
- We create a blinded receive which starts at the `starting_htlc_offset`
  plus any excess we want to add on for the recipient
- Blinded forwards don't care, as the cltv is inside of encrypted data

`TrampolineHop`:
- When we have a blinded tail, we need to include the full cltv for the
  blinded path including any `excess_final_cltv_delta`
  - This means that our trampoline hop will have the full value set

Order that makes the most sense:
- [x] Squash PR 
- [x] Rebase PR (keeping backup branch)
- [x] Rebase on 4402
- [ ] Check tests

New failure: when we *do not* replace the onion for blinded
success, we get a payment failure.

Replacement onion:
- Final recipient CLTV:
```
original_trampoline_cltv +
  starting_htlc_offset + excess_final_cltv
```

Regular onion:
- `send_payment_with_route` which will end up calling
  `send_payment_along_path` which calls `build_trampoline_onion_paylaods` with current block height + 1
