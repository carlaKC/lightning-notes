# Sweep P2A outputs on commitment transactions

## Review Round 1

### Set `AnchorDescriptor` output value to CSV and P2A anchor amounts

- We need to track the amount of our anchors because they're no variable
  (used to be fixed)

- We use `generate_claim`:
  - `rebroadcast_pending_claims`: To rebroadcast our existing claims
  - `update_claims_view_from_requests`: To update our claims when we
    get new information 
  - `update_claims_view_from_matched_txn`: when we get a new block,
    update our claims accordingly
  - `blocks_disconnected`: handling re-orgs

- `generate_claim`:
  - We pass in a `PackageTemplate` which describes one or more
    transactions that will be going on chain.
  - We define a package as "malleable" if we know the private keys
    that allow us to provide a valid witness for the tx; this means
    that we can batch it with others. Packages that are counter signed
    by our peer (for example) are not malleable.
  - This PR introduces a `debug_assert` that we have a zero fee
    commitments channel (if it wasn't a zero fee anchor)
    Q: Is this ok? Asked in comment.
- It also uses `shared_anchor_script_pubkey` which builds:
  - 0x4e 0x73 

Q: Why not using rust bitcoin? 
- We're on version 32 and it was included in v28

Q: What type of transactions are malleable?
`map_output_type_flags` is used to set the malleablity field on

- `RevokedOutput`: malleable/unpinnable - only we can claim it
- `RevokedHTLCOutput`: malleable
  - If we offered it, unpinnable (only we have the preimage)
  - If they offered it, pinnable (they could reveal preimage)
- `CounterPartyOfferedHTLCOutput`:
  - On the counterparty's commitment, htlc that we offered them
  - Preimage is known by us
  - malleable/unpinnable
- `CounterPartyReceivedHTLCOutput`:
  - On the counterparty's commitment, htlc that we received from them
  - Preimage is known by them, and could be revealed sneakily
  - malleable/pinnable
- `HTLCHolderOutput` with anchors: 
  - On our commitment, either received or offered htlc 
  - If we know the preimage, it's unpinnable because we can claim it
  - If we don't know the preimage, it's pinnable because they can reveal
- `HTLCHolderOutput` without anchors: untractable (signed by counterparty)
- `HolderFundingOutput`: untractable (signed by counterparty)

Q: Why is the debug assert on zero fee commitments safe?
- We're dealing with non-malleable packages, this means that we have:
  - `HolderHtlcOutput` without anchor support
  - `HolderFundingOutput`: just our funding output

Q: Does LDK allow non-anchor outputs?
- Yes, it's our default if we don't negotiate anchors.

`requires_external_funding`:
- Runs through all the inputs on a tx
- If our funding output is present, check whether we have anchors
- If there's a HTLC on our commitment, check whether we have anchors  
-> These are situations where we have to bump things!

### Set 0FC HolderHTLCOutput, HolderFundingOutput to require addl funds

Now that we have zero fees, we also need to provide additional funding
when we have a `HolderHTLCOutput` or `HolderFundingOutput`, because
the transaction must be bumped.

- We add an assert that the `HolderHTLCOutput` type and the
  `HolderFundingOutput` type are *only* for anchor channels when
  we call `amount` - this is only called for malleable packages, so
  it's safe to have this assert.
- Previously, we'd set zero fee htlc to malleable and other types
  to not malleable.
  - Now we also set zero fee commitments to malleable

Q: Why are these types only for anchors?

End of review: double check that we have `HolderFundingOutput` comment
still applies once we've updated malleability?
-> If we don't use the `HolderFundingOutput`/`HolderHTLCOutput` for
   static remote channels then we don't hit the assert issue
-> The amount debug that's been added isn't necessarily a deal breaker,
   because it's only called in a context for malleable stuff (which is
   anchors).

Q: Why would we only need the `amount` of `PackageSolveData` for malleable?
Q: Why is `HolderFundingOutput` allowed in `amount` but it is not
  malleable?

Q: Where do we have `HolderFundingOutput`?
- `generate_claimable_outpoints_and_watch_outputs`:
  - uses `::build`
  - Seems to be called for all commitment transactions, so I think the
    assert question still stands.


### Do not produce 0FC HTLC txs on unsafe_get_latest_holder_commitment_txn

- `unsafe_get_latest_holder_commitment_txn`:
  - Return a our commitment transaction for anchors and zfc because
    we can only deal with this right now
    - For zero fee, we could technically start to settle htlc second
      stage at the same time as the commitment (because they aren't
      CSV-ed), but we leave that for future.

### Delay HTLC txs in 0FC channels until both commit and anchor txs confirm

As above, just treating 0FC the same as anchors.

### Update handling of BumpTransactionEvent::ChannelClose for 0FC channels

- `handle_channel_close`:
  - This is only used in the context of anchor channels, because we're
    bumping the commitment tx; so it's okay that we assume we only have
    anchor channels here.

### remove test flag from negotiate_anchor_zero_fee_commitments

Just removes the test flag, can update the doc todo that I left.

### Drop `RevokedOutput::is_counterparty_balance_on_anchors`

Reviewed this when I was going through matt's branch.
