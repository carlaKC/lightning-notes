# Fail back before upstream claim [#3556](https://github.com/lightningdevkit/rust-lightning/pull/3556/commits/a78ea1ffe68cfa3f4b438bd7a1d52f2fe63d90b0)

- `PendingHtlcRouting` represents different types of htlcs that we can
  relay; the other variants already have the incoming cltv set because
  they're for receives and it's needed for final cltv delta check
- `HTLCPreviousHopData` stores the things that we need to remember about
  the htlc when we settle/fail it back (shared secret/blinding stuff
  etc).
  - This is persisted, so old forwards won't have it stored (option),
    added to the impl_writable_tlv_based macro to persist
  - Used in two places in the codebase:
    - ClaimableHTLC: a htlc terminating at our node, we could claim
    - HTLCSource: an outgoing htlc, if it was forwarded to us

Q: failed_back_htlc_ids is in-memory only, how does this behave after
   restart? Assuming that we'll hit the code that re-checks them and
   re-adds?

O: update_monitor has a new failure case introduced but no test, this
  is a chance to contribute!

Orthogonal observations:
- PR removes a fuzz test, take a look at how that commit works
(historical_inbound_htlc_fulfills)
- Take another look at htlc flow, specifically how these pieces fit in
