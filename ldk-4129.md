# Batching V3 HTLC Claims

## Review Pass 1

### Implement Holder HTLC claim chunking for 0FC channels

`unsigned_tx_weight` = `htlc_tx.to_wu() - (htlc_tx.input_len() * EMPTY_SCRIPT_SIG)`
Q: why do we subtract EMPTY_SCRIPT_SIG off the weight?
- They're replaced by the witness on signing

Q: Can we hit the `batch_size.checked_sub(htlcs_to_remove)`?
- Only if we have a really small number of htlcs left to remove, and
  in that case we're not going to hit the weight limit

- We no longer pass the `claim_id` into `handle_htlc_resolution` because
  we're going to make it inside the function where we do batching.
- We move the transaction creation and accumulation of `must_spend`
  down

Q: Is the 703 double counting the transaction overhead?
- Looks like it to me (version etc included here).

Create a loop that will run until the number of htlcs we've broadcast
is less than our total count.

Eg, start with 105 HTLCs.
Let's assume that 50 will fit in a batch.
- 40,000 wu total
- 50x htlcs @ 703 = 35150 
- Coin selection = 4850 wu to allow 50 htlcs

`broadcasted_htlcs` = 0;
`batch_size` = 105;
`htlcs` = `htlc_descriptors[0, 105]`

We run coin selection with all 105 htlcs.
- 105 htlcs @ 703 = 76650
- inputs @ 4850
= 81500

= 41500 extra (ignoring signatures for now)

(assuming that we're using htlc success for removal):
HTLCs to remove = (41500 / 703 + 2)
= 61 HTLCs

`batch_size` = 105 - 61 = 44
continue

`broadcasted_htlcs` = 0
`batch_size` = 44
`htlcs` = `htlc_descriptors[0,44]`

We run coin selection with 44 htlcs:
- 44 htlcs @ 703 = 30932
- inputs @ 4850
= 35,782

This will fit in our limit!

`broadcasted_htlcs` = 44
`batch_size` = 105 - 44 = 61
`htlcs` = `htlc_descriptors[44, 105]`

We run coin selection with 61 htlcs:
- 61 htlcs @ 703 = 42883
- inputs @ 4850
- 47733

This will not fit in our batch:
- Extra = 7733
- HTLCs to remove = (7733 / 703 + 2) = 13

`batch_size` = 61 - 13 = 48
`broadcasted_htlcs` = 44
`htlcs` = `htlc_descriptors[44, 44 + 48]` 

We run coin selection with 48 htlcs:
- 48 htlcs @ 703 = 33744
- inputs @ 4850
- 38594

This will fit in our limit!

`broadcasted_htlcs` = 44 + 48 = 92
`batch_size` = 105 - 92 = 13
`htlcs` = `htlc_descriptors[92, 92*13]`

We run coin selection with 13 htlcs:
- 13 htlcs @ 703
- inputs @ 4850

This will fit in our limit!
`broadcasted_htlcs` = 93 + 13 = 105

Our while loop will break and we're done!

Core logic looks good, give or take some nits, just need to review the
test.

`test_htlc_clain_chunking`:
- Setup 2 nodes, both accepting zero fee comms
- Fund them with a UTXO that they can use for bumping
- Create a zero fee commitment channel between them
- Create 75 htlcs on their commitment
- Claim the HTLCs on the receiver, clear any messages they'd want to
  exchange to update commitment
- Mine the commitment transaction that has the htlcs on it 
- Get the bump event on the claiming node and handle it
- Assert that we split up our HTLC claims
- Mine the first bump, but not the second one
- Assert that we'll bump the remaining 17

LGTM!

## Review Pass 2

### fixup: Use the weight of the single input-output pair, not the full tx

- Use constants?
- I do think we can only trigger on >, but not blocking

### fixup: remove unused vars in tests

- gg

### fixup: cap aggregation of HTLCs in anchors_zero_fee_htlc_tx channels …

- Looks good, nice comment

### fixup: allocate a USER_COINS_WEIGHT_BUDGET when selecting HTLCs in …

- We set a `USER_COINS_WEIGHT_BUDGET` of 1000 wu
- No longer generate `claim_id` beforehand
- Create a `must_spend` vector that can hold the full number of htlcs
  that we have left to broadcast
- Add the next htlc, and get its weight and check that it won't run
  over the max less the budget
- We then push into the must spend vecs
- Use the original claim id if we're running with the first one,
  otherwise generate a new `claim_id` 
  - It is nice that we get to use the `claim_id` that the event has
    at least for the first in the batch

### fixup: Asset TRUC transactions are below 10_000 WU in check_spends

- In test that check all the txns we're making!

### fixup: Add ClaimId::from_htlcs

- Adds requested function, nice

### Remainder

Other commits small fixups from previous comments.
