# Support Payments for less than the total MPP value

Aim is to be able to send a HTLC that's part of a MPP payment, but not
dispatch the `total_amount` described by the MPP. This could be helpful
for splitting a payment between different sources.

## Round 1
### Validate the `Router` is meeting MPP and max-fee limitations given

Aim:
- Validate that we stick within the limits provided
- Validate that we meet the MPP rules of not having a "redundant" part
  that takes us over the total amount.

We `debug_assert` that we haven't gotten back some routing params that
aren't ours. Not really sure why we wouldn't just fail here, seems
kinda whack (but is pre-existing).

### Include MPP payment amount in `RecipientOnionFields`

We need to separate:
- Payment amount: the amount that we're sending the recipient w/ this
  HTLC.
- MPP amount: the total amount that the recipient should expect from
  all the different parts.

Persistence of `onion_fields`:
- (option: ReadableArgs, amount_msat)
  - We call the read function on `ReadableArgs` and pass `amount_msat`
    into it). 
  - We have an impl of `ReadableArgs` for `RecipientOnionFields` that
    will take the amount and read appropriate fields.

`PaymentClaimable`:
- We fall back to `amount_msat`, which is the amount that was incoming
  for a payment.

`PaymentClaimed`:
- We fall back to `sender_intended_total_msat`, which is the total
  value that the sender intended to include.
- If that is not present (as it was added in ~.17), then we fall back
  to `amount_msat` which is the amount that could be claimed for the
  payment.

`onion_fields` will be written with `total_mpp_amount_msat`.

We will also write our events with the `amount_msat` that can be
claimed for the payment, and the `sender_intended_total_msat` which is
the amount the sender aimed to send us.

If the `onion_fields` don't have the `total_mpp_amount_msat` present,
then we'll fall back to our `sender_intended_total_msat` or
`amount_msat`. Since versions that _don't_ write `total_mpp_amount_msat`
will always set the _same_ `amount_msat` and `total_mpp_amount_msat`,
this value will be correct for older versions. Going forward, we'll
write both which allows us to send an amount that's not equal to the
MPP total.

Q: Why is unwrap on `amount_msat` okay?
- It's a wrapper, it must be there
- We're using a different macro, so it's different to the other place

Different values we have here:
- `amount_msat`: the actual total of all the htlcs that we received
- `sender_intended_total_msat`: the total that the sender meant to send
  us, which can be different to `amount_msat` if we allow people to skim
  off the top (eg, LSP), obtained from onion payload.
- `total_mpp_amount_msat`: the total of all the mpp parts that we're
  supposed to receive.

Q: `PendingHTLCRouting::ReceiveKeysend`:
- Set the amount in our onion to the `total_msat` intended, or the
  `outgoing_amt_msat`
- Is `payment_data` always `Some`? Yes, but with trampoline I think it
  won't be, so can just leave it as-is.

Q: How does `AmountlessClaimablePaymentHTLCOnion` work?
- Previously we wrote `claimable_htlc_onoin_fields`
- We'd just fill in the `onion_fields` for each of the
  `claimable_payments`
- Now we try to pull the `total_msat` off of `ClaimableHTLC`
- If the `onion_fields` have a `total_mpp_amount_msat` written but
  don't equal the `ClaimableHTLC.total_msat`, fail
- Create a `onion_field` that uses the `total_msat`

Q: Why are we adding debug asserts on `total_msat` and
  `recipient_onion.total_mpp_amount_msat`?
- [ ] Seems like we don't need this parameter anymore if we're going
  to just assert they're the same?

Q: Is it correct to use the same `payment_secret` as `recipient_onion`
  for `trampoline_outer_onion`?

`create_payment_onion_internal`:
- Took a `recipient_onion`
  - `build_trampoline_onion_payloads`
    - `build_onion_payloads_callback`
      - For blinded receive, just include the custom tlvs
      - For `TrampolineEntry`, pass `recipient_onion` (put as multipath
        trampoline data inside of trampoline entrypoint)
- We'd then call `build_onion_payloads` with the *same*
  `recipient_onion` for the _outer_ payload (providing the fully built
  `trampoline_packet_option`
- We were passing the `recipient_onion` through, but using the
  `total_msat` parameter, which is odd and duplicated (we didn't actually
  ever use the amount in the `recipient_onoin` to create our trampoline
  entries, and if we did they'd be wrong).
- This commit updates us to pass the correct value in the
  `recipient_onion`, and I believe we'll deprecate it in the commits
  that follow.

`outer_onion`:
- Use existing recipient fields is no trampoline
- Just use `payment_secret` of onion if trampoline; set amount to be
  the total amount that the onion packet expects to receive.

Q: Do we actually use the `recipient_onion` fields in trampoline?
  - The outer onion will contain the payment secret and amount
  - The inner onion will contain the `custom_tlvs`, but not
    `payment_metadata` because it's a bolt 11 concept?

### Replace existing MPP-total args with `RecipientOnionFields`

- Starts going through onion building and removing `total_msat` from
  functions so that we can instead rely on payment fields + building
  payloads from that recipient onion
- Remove the `total_msat` from `SendAlongPathArgs`, we already have
  a route that includes our amount and a recipient_onion that has the
  mpp total

### Add total-MPP-value storage in pending payments

- We need to also store this amount in
  `PendingOutboundPayments::Retryable` so that we can create correct
  retries with the right `onion_total_msat`. Without this, we'd just
  set the amount that we want to send to the `total_msat` which is more
  than we want to be sending.

### Allow BOLT 11 payments to be part of larger MPP payment

- Q: Can't `declared_total_mpp_value_override` just be a bool?
  No, because we want to support amount-less invoices

`pay_for_bolt11_invoice`:
- Accepts an `invoice` (which would have an `amount` if it's not a zero
  amount invoice!).
- `amount_msats`: assume this is the user-specified amount, yup
  - Not allowed to be less than the invoice amount _unless_ we're making
    a partial payment.
- If we're specifying a mpp override, it should be at least our amount
  (because we're paying this or more).
- Is the `total_override_msat` = `amount` something we want to support?

### Add pending changelog entry to note new backwards incompat

- We can't downgrade while trying to dispatch the payment because we
  need to know the `total_amount` we're paying.

## Require RecipientOnionFields in claimable HTLC pipeline

- We don't allow upgrade w/ in flights from versions that don't have
  these present
- Straightforward

### Drop `total_msat` from individual `ClaimableHTLC`

- Now that we require the presence of `RecipientOnionFields` in
  `ClaimableHTLC`, this was a yucky field (total across all htlcs
  was stored in each htlc).

## Round 2

### f fix validation ordering

- Switches order of validation so that error isn't silences

### f clarify trampoline onion params setup

- Adds comment explaining that we split the trampoline `RecipientOnion`
  between outer and inner onion.
- Also adds validation that we don't have payment metadata

### f return, don't override values

- Changes trampoline logic to return the onion we want rather than
  override.

### f msat / f clarify

Trivial typo fixes.

## Round 2

New PR:
c31a7bee2..a28e7e63a

ca35e2b06..190c88ed9

Trivial changes, fixes silent rebase tests failures + addresses E's
comments.
