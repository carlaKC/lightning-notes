# HTLC Interception

## Issue Writeup

https://github.com/lightningdevkit/rust-lightning/issues/2855

- LDK currently has the ability to intercept HTLCs that have "magic"
  SCID values (which belong to phantom payments), it would also
  be good to just provide regular interception.
- 

Related issues:
- https://github.com/lightningdevkit/rust-lightning/issues/2320: reject
  HTLCs if running low on funds.
- https://github.com/lightningdevkit/rust-lightning/issues/2425: ability
  to add reputation algorithm.
  - Matt [notes](https://github.com/lightningdevkit/rust-lightning/issues/2425#issuecomment-1639046677)
    that we don't really want this handled via events (which users
    have to handle).
  - [Rather](https://github.com/lightningdevkit/rust-lightning/issues/2425#issuecomment-1648757397)
    it should be its own trait with sane defaults.
  - If the DOS-limiter allows a HTLC, it should still allow a
    [PendingHTLCsForwardable](https://github.com/lightningdevkit/rust-lightning/issues/2425#issuecomment-1684225186) event to be processed.
- https://github.com/lightningdevkit/rust-lightning/issues/2839:
  provides the option to externally provide a preimage for interception

## Draft PR

https://github.com/lightningdevkit/rust-lightning/pull/3843

There is a draft PR up that starts to address this issue. It needs
rebase and has been stale since 13 June. Some relevant points to
consider:
- [Concern](https://github.com/lightningdevkit/rust-lightning/pull/3843#issuecomment-2967983465)
  that a handler can block hot paths in LDK. Noted that the events
  approach could help with this.
- [Callback](https://github.com/lightningdevkit/rust-lightning/pull/3843#pullrequestreview-2924773696)
  to decide what to do with a HTLC later on seem to be required, no
  matter what approach is used.
- Suggestion to instead have a "do we want to intercept this"
  trait, and then use the existing interception logic.

## Existing Interception Logic

- There is a `HTLCIntercepted` event:
  - Currently generated for scids that are set using routing hints
  - Must be resolved with `forward_intercepted_htlc` or
    `fail_intercepted_htlc`
  - Also need to set `accept_intercept_htlcs` in your config to get
    these.
  - Contains the payment hash, next hop, inbound/outbound amount

Event creation:
- `forward_htlcs`:
  - Drain all pending forwards
  - If not our SCID 
  - We generate an interception ID
  - We add the HTLC to our pending intercepts

HTLC Forward:
- Get the alias of the peer that the outgoing channel belongs to
- Remove the HTLC from `pending_intercepted_htlcs`
- Create a HTLC to forward
- Individually call `forward_htlcs` with that single HTLC that we've
  freed

HTLC Fail:
- Gets the HTLC out of `pending_intercepted_htlcs`
- `fail_htlc_backwards_internal`
  - This is always called with `UnknownNextPeer`

## Re-Use of Interception for Jamming
[ ] Could add a `should_intercept_htlc` trait in front of where we
    add the interception event:
    Q: What if it's also a SCID intercept?
    Q: How do we handle errors here?
    Q: How do we think about blocking?
    Q: Would it cause a problem to be calling `forward_htlcs` on every
       single htlc when we call `forward_intercepted_htlc`? If we did
       general interception on every htlc, that could get heavy?
[ ] Would need to provide a different reason to failing in
    `fail_intercepted_htlc`
[ ] Doesn't have the expiry height of the HTLC.
